{"version":3,"file":"index.js","sources":["uni_modules/lime-transition/index.ts"],"sourcesContent":["// @ts-nocheck\r\nimport { raf } from '@/uni_modules/lime-shared/raf';\r\n// #ifndef UNI-APP-X\r\nimport { watchEffect, ref, nextTick } from '@/uni_modules/lime-shared/vue'\r\n// #endif\r\n\r\nexport type TransitionEmitStatus = \"before-enter\" | \"enter\" | \"after-enter\" | \"before-leave\" | \"leave\" | \"after-leave\"\r\nexport type TransitionStatus = '' | 'enter' | 'leave';\r\nexport type UseTransitionOptions = {\r\n\telement ?: Ref<UniElement | null>,\r\n\tenterClass ?: string,\r\n\tenterActiveClass ?: string,\r\n\tenterToClass ?: string,\r\n\tleaveClass ?: string,\r\n\tleaveActiveClass ?: string,\r\n\tleaveToClass ?: string,\r\n\tappear ?: boolean,\r\n\tdefaultName ?: string,\r\n\tname ?: () => string,\r\n\tvisible ?: () => boolean,\r\n\temits ?: (name : TransitionEmitStatus) => void,\r\n\tonNextTick ?: (name : TransitionEmitStatus) => Promise<void>,\r\n\tduration ?: number\r\n}\r\n\r\ntype ClassNameMap = Map<string, string>;\r\n\r\nexport type UseTransitionReturn = {\r\n\tstate : Ref<boolean>,\r\n\tdisplay : Ref<boolean>,\r\n\tinited : Ref<boolean>,\r\n\tclasses : Ref<string>,\r\n\tname : Ref<string>,\r\n\tfinished : () => void,\r\n\ttoggle : (v : boolean) => void,\r\n}\r\n\r\nexport function useTransition(options : UseTransitionOptions) : UseTransitionReturn {\r\n\tconst state = ref(false);\r\n\tconst display = ref(false);\r\n\tconst inited = ref(false);\r\n\tconst classes = ref('');\r\n\tconst name = ref(options.defaultName ?? 'fade');\r\n\r\n\tconst enterClass = options.enterClass ?? '';\r\n\tconst enterActiveClass = options.enterActiveClass ?? '';\r\n\tconst enterToClass = options.enterToClass ?? '';\r\n\tconst leaveActiveClass = options.leaveActiveClass ?? '';\r\n\tconst leaveToClass = options.leaveToClass ?? '';\r\n\tconst leaveClass = options.leaveClass ?? '';\r\n\r\n\tconst appear = options.appear ?? false\r\n\tconst duration = options.duration ?? 300;\r\n\r\n\tlet status : TransitionStatus = '';\r\n\tlet isTransitionEnd = false;\r\n\tlet isTransitioning = false;\r\n\tlet timeoutId = -1\r\n\r\n\tconst emitEvent = (event : TransitionEmitStatus) => {\r\n\t\toptions.emits?.(event);\r\n\t};\r\n\r\n\t// 结束\r\n\tconst finished = () => {\r\n\t\tif (isTransitionEnd) return;\r\n\t\tisTransitionEnd = true;\r\n\t\temitEvent(`after-${status}`)\r\n\t\tif (display.value && !state.value) {\r\n\t\t\tdisplay.value = false\r\n\t\t}\r\n\t}\r\n\r\n\tconst sleep = () : Promise<void> => {\r\n\t\treturn new Promise((resolve) => {\r\n\t\t\tnextTick(() => {\r\n\t\t\t\traf(() => {\r\n\t\t\t\t\t// #ifdef APP-ANDROID || APP-IOS || APP-HARMONY\r\n\t\t\t\t\tif (options.element?.value != null) {\r\n\t\t\t\t\t\toptions.element?.value?.getBoundingClientRectAsync()?.then(res => {\r\n\t\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// #endif\r\n\t\t\t\t\t// #ifndef APP-ANDROID || APP-IOS || APP-HARMONY\r\n\t\t\t\t\tresolve()\r\n\t\t\t\t\t// #endif\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t})\r\n\t}\r\n\r\n\tconst getClassNames = (name : string) : ClassNameMap => {\r\n\t\treturn new Map<string, string>([\r\n\t\t\t['enter', `l-${name}-enter l-${name}-enter-active ${enterClass} ${enterActiveClass}`],\r\n\t\t\t['enter-to', `l-${name}-enter-to l-${name}-enter-active ${enterToClass} ${enterActiveClass}`],\r\n\t\t\t['leave', `l-${name}-leave l-${name}-leave-active ${leaveClass} ${leaveActiveClass}`],\r\n\t\t\t['leave-to', `l-${name}-leave-to l-${name}-leave-active ${leaveToClass} ${leaveActiveClass}`]\r\n\t\t])\r\n\t};\r\n\r\n\tconst transitionQueue = ref<TransitionStatus[]>([]);\r\n\r\n\tconst performTransition = async (newStatus : TransitionStatus, eventName : TransitionStatus) => {\r\n\t\tif (status == newStatus) return\r\n\t\ttransitionQueue.value.push(newStatus);\r\n\t\tif (isTransitioning) return;\r\n\t\tisTransitioning = true;\r\n\t\t// 防止因结束 又切换为开始导致闪烁\r\n\t\tisTransitionEnd = true;\r\n\t\twhile (transitionQueue.value.length > 0) {\r\n\t\t\tconst currentStatus = transitionQueue.value.shift()!;\r\n\t\t\tstatus = currentStatus;\r\n\t\t\temitEvent(`before-${eventName}`);\r\n\r\n\t\t\tawait sleep();\r\n\t\t\tawait sleep();\r\n\t\t\tif (status != currentStatus) continue;\r\n\r\n\t\t\tconst classNames = getClassNames(name.value);\r\n\t\t\tinited.value = true;\r\n\t\t\tdisplay.value = true;\r\n\t\t\tclasses.value = classNames.get(eventName)!;\r\n\t\t\temitEvent(eventName);\r\n\r\n\t\t\tconst executeAfterTick = options.onNextTick?.(eventName);\r\n\t\t\tif (executeAfterTick != null) {\r\n\t\t\t\tawait executeAfterTick;\r\n\t\t\t}\r\n\r\n\t\t\tawait sleep();\r\n\t\t\t// #ifdef MP\r\n\t\t\tawait sleep();\r\n\t\t\tawait sleep();\r\n\t\t\t// #endif\r\n\t\t\tif (status != currentStatus) continue;\r\n\t\t\tclasses.value = classNames.get(`${eventName}-to`)!;\r\n\t\t\t// isTransitionEnd = false;\r\n\t\t\t// 防止最后无法关闭\r\n\t\t\tif (status == 'leave') {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tfinished()\r\n\t\t\t\t}, duration)\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\t// 不延迟 会导致快速切换时 因display none 闪烁\r\n\t\tclearTimeout(timeoutId)\r\n\t\ttimeoutId = setTimeout(() => {\r\n\t\t\tif (transitionQueue.value.length == 0 && status == newStatus) {\r\n\t\t\t\tisTransitionEnd = false;\r\n\t\t\t}\r\n\t\t}, duration * 0.8)\r\n\r\n\t\tisTransitioning = false;\r\n\t}\r\n\t// 定义进入过渡的函数\r\n\tconst enter = () => {\r\n\t\tperformTransition('enter', 'enter');\r\n\t}\r\n\r\n\r\n\tconst leave = () => {\r\n\t\tperformTransition('leave', 'leave');\r\n\t}\r\n\r\n\tlet init = false;\r\n\twatchEffect(() => {\r\n\t\tif (options.visible == null) return\r\n\t\tstate.value = options.visible!();\r\n\t\tif (!appear && !init) {\r\n\t\t\tinit = true\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tif (state.value) {\r\n\t\t\tenter()\r\n\t\t} else {\r\n\t\t\tleave()\r\n\t\t}\r\n\t})\r\n\twatchEffect(() => {\r\n\t\tif (options.name == null) return\r\n\t\tname.value = options.name!()\r\n\t})\r\n\r\n\tconst toggle = (v : boolean) => {\r\n\t\tstate.value = v\r\n\t\tif (v) {\r\n\t\t\tenter()\r\n\t\t} else {\r\n\t\t\tleave()\r\n\t\t}\r\n\t}\r\n\r\n\treturn {\r\n\t\tstate,\r\n\t\tinited,\r\n\t\tdisplay,\r\n\t\tclasses,\r\n\t\tname,\r\n\t\tfinished,\r\n\t\ttoggle\r\n\t} as UseTransitionReturn\r\n}"],"names":["ref","_a","nextTick","raf","name","__awaiter","watchEffect"],"mappings":"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"}