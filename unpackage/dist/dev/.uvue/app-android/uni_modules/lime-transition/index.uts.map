{"version":3,"file":"index.uts","sourceRoot":"","sources":["uni_modules/lime-transition/index.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-nocheck\r\nimport { raf } from '@/uni_modules/lime-shared/raf';\r\n\r\n\r\n\r\n\r\nexport type TransitionEmitStatus = \"before-enter\" | \"enter\" | \"after-enter\" | \"before-leave\" | \"leave\" | \"after-leave\"\r\nexport type TransitionStatus = '' | 'enter' | 'leave';\r\nexport type UseTransitionOptions = {\r\n\telement ?: Ref<UniElement | null>,\r\n\tenterClass ?: string,\r\n\tenterActiveClass ?: string,\r\n\tenterToClass ?: string,\r\n\tleaveClass ?: string,\r\n\tleaveActiveClass ?: string,\r\n\tleaveToClass ?: string,\r\n\tappear ?: boolean,\r\n\tdefaultName ?: string,\r\n\tname ?: () => string,\r\n\tvisible ?: () => boolean,\r\n\temits ?: (name : TransitionEmitStatus) => void,\r\n\tonNextTick ?: (name : TransitionEmitStatus) => Promise<void>,\r\n\tduration ?: number\r\n}\r\n\r\ntype ClassNameMap = Map<string, string>;\r\n\r\nexport type UseTransitionReturn = {\r\n\tstate : Ref<boolean>,\r\n\tdisplay : Ref<boolean>,\r\n\tinited : Ref<boolean>,\r\n\tclasses : Ref<string>,\r\n\tname : Ref<string>,\r\n\tfinished : () => void,\r\n\ttoggle : (v : boolean) => void,\r\n}\r\n\r\nexport function useTransition(options : UseTransitionOptions) : UseTransitionReturn {\r\n\tconst state = ref(false);\r\n\tconst display = ref(false);\r\n\tconst inited = ref(false);\r\n\tconst classes = ref('');\r\n\tconst name = ref(options.defaultName ?? 'fade');\r\n\r\n\tconst enterClass = options.enterClass ?? '';\r\n\tconst enterActiveClass = options.enterActiveClass ?? '';\r\n\tconst enterToClass = options.enterToClass ?? '';\r\n\tconst leaveActiveClass = options.leaveActiveClass ?? '';\r\n\tconst leaveToClass = options.leaveToClass ?? '';\r\n\tconst leaveClass = options.leaveClass ?? '';\r\n\r\n\tconst appear = options.appear ?? false\r\n\tconst duration = options.duration ?? 300;\r\n\r\n\tlet status : TransitionStatus = '';\r\n\tlet isTransitionEnd = false;\r\n\tlet isTransitioning = false;\r\n\tlet timeoutId = -1\r\n\r\n\tconst emitEvent = (event : TransitionEmitStatus) => {\r\n\t\toptions.emits?.(event);\r\n\t};\r\n\r\n\t// 结束\r\n\tconst finished = () => {\r\n\t\tif (isTransitionEnd) return;\r\n\t\tisTransitionEnd = true;\r\n\t\temitEvent(`after-${status}`)\r\n\t\tif (display.value && !state.value) {\r\n\t\t\tdisplay.value = false\r\n\t\t}\r\n\t}\r\n\r\n\tconst sleep = () : Promise<void> => {\r\n\t\treturn new Promise((resolve) => {\r\n\t\t\tnextTick(() => {\r\n\t\t\t\traf(() => {\r\n\r\n\t\t\t\t\tif (options.element?.value != null) {\r\n\t\t\t\t\t\toptions.element?.value?.getBoundingClientRectAsync()?.then(res => {\r\n\t\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tresolve()\r\n\t\t\t\t\t}\r\n\r\n\r\n\r\n\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t})\r\n\t}\r\n\r\n\tconst getClassNames = (name : string) : ClassNameMap => {\r\n\t\treturn new Map<string, string>([\r\n\t\t\t['enter', `l-${name}-enter l-${name}-enter-active ${enterClass} ${enterActiveClass}`],\r\n\t\t\t['enter-to', `l-${name}-enter-to l-${name}-enter-active ${enterToClass} ${enterActiveClass}`],\r\n\t\t\t['leave', `l-${name}-leave l-${name}-leave-active ${leaveClass} ${leaveActiveClass}`],\r\n\t\t\t['leave-to', `l-${name}-leave-to l-${name}-leave-active ${leaveToClass} ${leaveActiveClass}`]\r\n\t\t])\r\n\t};\r\n\r\n\tconst transitionQueue = ref<TransitionStatus[]>([]);\r\n\r\n\tconst performTransition = async (newStatus : TransitionStatus, eventName : TransitionStatus) => {\r\n\t\tif (status == newStatus) return\r\n\t\ttransitionQueue.value.push(newStatus);\r\n\t\tif (isTransitioning) return;\r\n\t\tisTransitioning = true;\r\n\t\t// 防止因结束 又切换为开始导致闪烁\r\n\t\tisTransitionEnd = true;\r\n\t\twhile (transitionQueue.value.length > 0) {\r\n\t\t\tconst currentStatus = transitionQueue.value.shift()!;\r\n\t\t\tstatus = currentStatus;\r\n\t\t\temitEvent(`before-${eventName}`);\r\n\r\n\t\t\tawait sleep();\r\n\t\t\tawait sleep();\r\n\t\t\tif (status != currentStatus) continue;\r\n\r\n\t\t\tconst classNames = getClassNames(name.value);\r\n\t\t\tinited.value = true;\r\n\t\t\tdisplay.value = true;\r\n\t\t\tclasses.value = classNames.get(eventName)!;\r\n\t\t\temitEvent(eventName);\r\n\r\n\t\t\tconst executeAfterTick = options.onNextTick?.(eventName);\r\n\t\t\tif (executeAfterTick != null) {\r\n\t\t\t\tawait executeAfterTick;\r\n\t\t\t}\r\n\r\n\t\t\tawait sleep();\r\n\r\n\r\n\r\n\r\n\t\t\tif (status != currentStatus) continue;\r\n\t\t\tclasses.value = classNames.get(`${eventName}-to`)!;\r\n\t\t\t// isTransitionEnd = false;\r\n\t\t\t// 防止最后无法关闭\r\n\t\t\tif (status == 'leave') {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tfinished()\r\n\t\t\t\t}, duration)\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\t// 不延迟 会导致快速切换时 因display none 闪烁\r\n\t\tclearTimeout(timeoutId)\r\n\t\ttimeoutId = setTimeout(() => {\r\n\t\t\tif (transitionQueue.value.length == 0 && status == newStatus) {\r\n\t\t\t\tisTransitionEnd = false;\r\n\t\t\t}\r\n\t\t}, duration * 0.8)\r\n\r\n\t\tisTransitioning = false;\r\n\t}\r\n\t// 定义进入过渡的函数\r\n\tconst enter = () => {\r\n\t\tperformTransition('enter', 'enter');\r\n\t}\r\n\r\n\r\n\tconst leave = () => {\r\n\t\tperformTransition('leave', 'leave');\r\n\t}\r\n\r\n\tlet init = false;\r\n\twatchEffect(() => {\r\n\t\tif (options.visible == null) return\r\n\t\tstate.value = options.visible!();\r\n\t\tif (!appear && !init) {\r\n\t\t\tinit = true\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tif (state.value) {\r\n\t\t\tenter()\r\n\t\t} else {\r\n\t\t\tleave()\r\n\t\t}\r\n\t})\r\n\twatchEffect(() => {\r\n\t\tif (options.name == null) return\r\n\t\tname.value = options.name!()\r\n\t})\r\n\r\n\tconst toggle = (v : boolean) => {\r\n\t\tstate.value = v\r\n\t\tif (v) {\r\n\t\t\tenter()\r\n\t\t} else {\r\n\t\t\tleave()\r\n\t\t}\r\n\t}\r\n\r\n\treturn {\r\n\t\tstate,\r\n\t\tinited,\r\n\t\tdisplay,\r\n\t\tclasses,\r\n\t\tname,\r\n\t\tfinished,\r\n\t\ttoggle\r\n\t} as UseTransitionReturn\r\n}"]}