{"version":3,"sources":["pages/index/deviceReplay.uvue"],"names":[],"mappings":";;;SAEC,IAIc;IAJD,KAAc,MAAd,iBAAc","file":"pages/index/deviceReplay.uvue","sourceRoot":"","sourcesContent":["<template>\n\n\t<scroll-view style=\"flex:1\">\n\n\t\t\n\n\t</scroll-view>\n\n</template>\n\n<script setup>\n\t\t\n</script>\n\n<style>\n\t\t\n</style>\n\n<!-- <template>\n  <view class=\"video-container\">\n    <video \n      id=\"myVideo\"\n      class=\"video-player\"\n      :src=\"videoSrc\"\n      :controls=\"false\"\n      @timeupdate=\"onTimeUpdate\"\n      @play=\"onPlay\"\n      @pause=\"onPause\"\n      @ended=\"onEnded\"\n      @loadedmetadata=\"onLoadedMetadata\"\n    ></video>\n    \n    <view class=\"video-controls\">\n      <button @tap=\"togglePlay\">{{ isPlaying ? '暂停' : '播放' }}</button>\n      <view class=\"time-display\">{{ formatTime(currentTime) }} / {{ formatTime(duration) }}</view>\n      <button @tap=\"addPlaybackMarker\">添加标记</button>\n    </view>\n    \n    <view \n      class=\"waveform-container\"\n      @touchstart=\"onTouchStart\"\n      @touchmove=\"onTouchMove\"\n      @touchend=\"onTouchEnd\"\n      @click=\"onWaveformClick\"\n    >\n      <view class=\"waveform-background\">\n        <view \n          v-for=\"(wave, index) in waveformData\" \n          :key=\"'bg-'+index\"\n          class=\"wave-bar bg-wave\"\n          :style=\"{\n            height: `${wave.height}px`,\n            left: `${wave.position}%`\n          }\"\n        ></view>\n      </view>\n      \n      <view class=\"waveform-foreground\" :style=\"{ width: `${playbackProgress}%` }\">\n        <view \n          v-for=\"(wave, index) in waveformData\" \n          :key=\"'fg-'+index\"\n          class=\"wave-bar fg-wave\"\n          :style=\"{\n            height: `${wave.height}px`,\n            left: `${wave.position}%`\n          }\"\n        ></view>\n      </view>\n      \n      <view \n        class=\"playhead\"\n        :style=\"{ left: `${playbackProgress}%` }\"\n      ></view>\n      \n      <view \n        v-for=\"(marker, index) in playbackMarkers\"\n        :key=\"'marker-'+index\"\n        class=\"playback-marker\"\n        :style=\"{ left: `${(marker.time / duration) * 100}%` }\"\n        @tap.stop=\"jumpToMarker(marker.time)\"\n      >\n        <view class=\"marker-tooltip\">{{ formatTime(marker.time) }}</view>\n      </view>\n    </view>\n    \n    <view class=\"playback-controls\">\n      <button @tap=\"startPlayback\" :disabled=\"playbackMarkers.length === 0\">开始回放</button>\n      <button @tap=\"stopPlayback\">停止回放</button>\n      <button @tap=\"clearMarkers\">清除标记</button>\n    </view>\n  </view>\n</template>\n\n<script setup lang=\"uts\">\nimport { ref, onMounted } from 'vue'\nimport { onReady } from '@dcloudio/uni-app'\n\ninterface WaveformPoint {\n  height: number\n  position: number\n  time: number\n}\n\ninterface PlaybackMarker {\n  time: number\n}\n\nconst videoSrc = ref(\"https://qiniu-web-assets.dcloud.net.cn/video/sample/2minute-demo.mp4\")\n\nconst isPlaying = ref(false)\nconst currentTime = ref(0)\nconst duration = ref(0)\nconst playbackProgress = ref(0)\n\nconst isDragging = ref(false)\nconst wasPlayingBeforeDrag = ref(false)\n\nconst waveformData = ref<Array<WaveformPoint>>(new Array<WaveformPoint>())\n\nconst playbackMarkers = ref<Array<PlaybackMarker>>(new Array<PlaybackMarker>())\n\nlet videoContext = uni.createVideoContext('myVideo')\nlet waveformContainer = uni.createSelectorQuery().in(this).select('.waveform-container')\n\nconst generateWaveform = () => {\n  const waves = new Array<WaveformPoint>()\n  const pointCount = 150 \n  \n  const totalDuration = duration.value > 0 ? duration.value : 120\n  \n  for (let i = 0; i <= pointCount; i++) {\n    const position = (i / pointCount) * 100\n    const time = (i / pointCount) * totalDuration\n    \n    const baseHeight = 8 + Math.sin(i / 8) * 8\n    const randomFactor = 1 + Math.random() * 0.5\n    const height = baseHeight * randomFactor\n    \n    waves.push({\n      height: height,\n      position: position,\n      time: time\n    } as WaveformPoint)\n  }\n  \n  waveformData.value = waves\n}\n\nconst onLoadedMetadata = (e: UniVideoTimeUpdateEvent) => {\n  duration.value = e.detail.duration\n\tgenerateWaveform()\n  \n}\n\nconst formatTime = (time: number): string => {\n  const minutes = Math.floor(time / 60)\n  const seconds = Math.floor(time % 60)\n  return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`\n}\n\nconst onTimeUpdate = (e: UniVideoTimeUpdateEvent) => {\n  if (!isDragging.value) {\n    currentTime.value = e.detail.currentTime\n    duration.value = e.detail.duration\n    playbackProgress.value = (currentTime.value / duration.value) * 100\n  }\n}\n\nconst updateCurrentTime = (e: UniTouchEvent) => {\n  if (e.touches.length === 0) return\n  \n  waveformContainer?.boundingClientRect((rect: UniApp.BoundingClientRect) => {\n    if (!rect?.width) return\n    \n    const touchX = Math.max(0, Math.min(e.touches[0]?.clientX - rect.left, rect.width))\n    const percent = touchX / rect.width\n    currentTime.value = percent * duration.value\n    playbackProgress.value = percent * 100\n  }).exec()\n}\n\nconst onTouchStart = (e: UniTouchEvent) => {\n  isDragging.value = true\n  wasPlayingBeforeDrag.value = isPlaying.value\n  if (isPlaying.value) {\n    videoContext?.pause()\n  }\n  updateCurrentTime(e)\n}\n\nconst onTouchMove = (e: UniTouchEvent) => {\n  if (!isDragging.value) return\n  e.stopPropagation()\n  e.preventDefault()\n  updateCurrentTime(e)\n}\n\nconst onTouchEnd = (e: UniTouchEvent) => {\n  if (!isDragging.value) return\n  e.stopPropagation()\n  e.preventDefault()\n  \n  updateCurrentTime(e)\n  videoContext?.seek(currentTime.value)\n  \n  setTimeout(() => {\n    if (wasPlayingBeforeDrag.value) {\n      videoContext?.play()\n    }\n    isDragging.value = false\n  }, 50)\n}\n\nconst onWaveformClick = (e: UniTouchEvent) => {\n  updateCurrentTime(e)\n  videoContext?.seek(currentTime.value)\n}\n\nconst togglePlay = () => {\n  if (isPlaying.value) {\n    videoContext?.pause()\n  } else {\n    videoContext?.play()\n  }\n}\n\nconst onPlay = () => {\n  isPlaying.value = true\n}\n\nconst onPause = () => {\n  isPlaying.value = false\n}\n\nconst onEnded = () => {\n  isPlaying.value = false\n  currentTime.value = 0\n  playbackProgress.value = 0\n}\n\nconst addPlaybackMarker = () => {\n  if (duration.value <= 0) return\n  \n  const existingMarker = playbackMarkers.value.find(\n    marker => Math.abs(marker.time - currentTime.value) < 0.5\n  )\n  \n  if (!existingMarker) {\n    playbackMarkers.value.push({\n      time: currentTime.value\n    } as PlaybackMarker)\n  }\n}\n\nconst jumpToMarker = (time: number) => {\n  videoContext?.seek(time)\n  currentTime.value = time\n  playbackProgress.value = (time / duration.value) * 100\n}\n\nconst startPlayback = () => {\n  if (playbackMarkers.value.length === 0) return\n  \n  playbackMarkers.value.sort((a, b) => a.time - b.time)\n  \n  let nextMarkerIndex = playbackMarkers.value.findIndex(marker => marker.time > currentTime.value)\n  if (nextMarkerIndex === -1) nextMarkerIndex = 0\n  \n  const playToMarker = (index: number) => {\n    if (index >= playbackMarkers.value.length) {\n      videoContext?.pause()\n      return\n    }\n    \n    const marker = playbackMarkers.value[index]\n    videoContext?.seek(marker.time)\n    videoContext?.play()\n    \n    setTimeout(() => {\n      videoContext?.pause()\n      currentTime.value = marker.time\n      playbackProgress.value = (marker.time / duration.value) * 100\n      \n      playToMarker(index + 1)\n    }, (marker.time - currentTime.value) * 1000)\n  }\n  \n  playToMarker(nextMarkerIndex)\n}\n\nconst stopPlayback = () => {\n  videoContext?.pause()\n}\n\nconst clearMarkers = () => {\n  playbackMarkers.value = new Array<PlaybackMarker>()\n}\nonMounted(() => {\n  onReady(() => {\n    videoContext = uni.createVideoContext('myVideo')\n    waveformContainer = uni.createSelectorQuery().in(this).select('.waveform-container')\n    generateWaveform()\n  })\n})\n</script>\n\n<style>\n.video-container {\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n  padding: 10px;\n  box-sizing: border-box;\n}\n\n.video-player {\n  width: 100%;\n  height: 300rpx;\n  background-color: #000;\n  border-radius: 8px;\n}\n\n.video-controls {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 10px 0;\n  margin-top: 8px;\n}\n\n.video-controls button {\n  padding: 6px 12px;\n  font-size: 14px;\n  border-radius: 4px;\n  background-color: #f0f0f0;\n  border: 1px solid #ddd;\n}\n\n.time-display {\n  font-size: 14px;\n  color: #333;\n  font-family: monospace;\n}\n\n.waveform-container {\n  position: relative;\n  height: 80px;\n  margin-top: 15px;\n  touch-action: none;\n  background-color: #f8f8f8;\n  border-radius: 8px;\n  overflow: hidden;\n}\n.waveform-background {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n}\n\n.waveform-foreground {\n  position: absolute;\n  top: 0;\n  left: 0;\n  bottom: 0;\n  overflow: hidden;\n}\n\n.wave-bar {\n  position: absolute;\n  bottom: 0;\n  width: 2px;\n  min-height: 1px;\n  border-radius: 1px;\n  transform: translateX(-50%);\n}\n\n.bg-wave {\n  background-color: #d1d1d1;\n}\n\n.fg-wave {\n  background-color: #FF5500;\n}\n\n.playhead {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  width: 2px;\n  background-color: #FF0000;\n  transform: translateX(-50%);\n  z-index: 20;\n  pointer-events: none;\n}\n\n.playback-marker {\n  position: absolute;\n  top: 0;\n  width: 10px;\n  height: 10px;\n  border-radius: 50%;\n  background-color: #FF5500;\n  transform: translateX(-50%) translateY(-50%);\n  z-index: 15;\n  border: 2px solid white;\n}\n\n.marker-tooltip {\n  position: absolute;\n  bottom: 100%;\n  left: 50%;\n  transform: translateX(-50%);\n  background-color: rgba(0, 0, 0, 0.7);\n  color: white;\n  padding: 4px 8px;\n  border-radius: 4px;\n  font-size: 12px;\n  white-space: nowrap;\n  opacity: 0;\n  transition: opacity 0.2s;\n  pointer-events: none;\n}\n\n.playback-marker:hover .marker-tooltip {\n  opacity: 1;\n}\n\n.playback-controls {\n  display: flex;\n  justify-content: space-around;\n  margin-top: 15px;\n}\n\n.playback-controls button {\n  padding: 8px 16px;\n  border-radius: 6px;\n  font-size: 14px;\n  background-color: #FF5500;\n  color: white;\n  border: none;\n}\n\n.playback-controls button:disabled {\n  background-color: #ccc;\n  opacity: 0.7;\n}\n</style> -->"]}